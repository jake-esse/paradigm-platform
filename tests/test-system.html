<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Paradigm Permission System Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1000px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #007bff;
            padding-bottom: 10px;
            position: relative;
        }
        .auth-info {
            position: absolute;
            right: 0;
            top: 0;
            font-size: 14px;
            font-weight: normal;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .auth-info .user-email {
            color: #666;
        }
        .logout-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        .logout-btn:hover {
            background: #c82333;
        }
        .test-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        button.grant {
            background: #28a745;
        }
        button.grant:hover {
            background: #218838;
        }
        button.revoke {
            background: #dc3545;
        }
        button.revoke:hover {
            background: #c82333;
        }
        button.check {
            background: #17a2b8;
        }
        button.check:hover {
            background: #138496;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        .warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        .data-type {
            display: inline-block;
            padding: 5px 10px;
            margin: 5px;
            background: #e9ecef;
            border-radius: 15px;
            font-size: 14px;
        }
        .request-item, .permission-item {
            margin: 10px 0;
            padding: 15px;
            background: white;
            border-radius: 5px;
            border: 1px solid #dee2e6;
        }
        .status-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: bold;
        }
        .status-pending { background: #ffeaa7; color: #856404; }
        .status-approved { background: #55efc4; color: #00b894; }
        .status-active { background: #74b9ff; color: #0984e3; }
        .status-expired { background: #fab1a0; color: #d63031; }
    </style>
</head>
<body>
    <h1>
        üöÄ Paradigm Permission System Test
        <div class="auth-info" id="authInfo" style="display: none;">
            <span class="user-email" id="userEmail"></span>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
    </h1>

    <!-- TEMPORARY TOKEN HELPER -->
    <div style="background: yellow; padding: 10px; margin: 10px 0; border: 2px solid orange;">
        <button onclick="showToken()">üìã Copy Auth Token for Testing</button>
        <pre id="tokenDisplay" style="margin-top: 10px; word-wrap: break-word;"></pre>
    </div>

    <div class="test-card">
        <h2>üìä Available Data Types</h2>
        <button onclick="loadDataTypes()">Load Data Types</button>
        <div id="dataTypes" class="result"></div>
    </div>

    <div class="test-card">
        <h2>üì± Sample App</h2>
        <button onclick="loadSampleApp()">Load Sample App</button>
        <div id="sampleApp" class="result"></div>
    </div>

    <div class="test-card">
        <h2>üîê Request Permission</h2>
        <button onclick="requestPermission('fitness')">Request Fitness Data</button>
        <button onclick="requestPermission('financial')">Request Financial Data</button>
        <button onclick="requestPermission('location')">Request Location Data</button>
        <button onclick="requestPermission('medical')">Request Medical Data</button>
        <div id="permissionResult" class="result"></div>
    </div>

    <div class="test-card">
        <h2>üìã Pending Permission Requests</h2>
        <button onclick="viewRequests()">Refresh Requests</button>
        <div id="requests" class="result"></div>
    </div>

    <div class="test-card">
        <h2>‚úÖ Check Permissions</h2>
        <button class="check" onclick="checkPermission('fitness')">Check Fitness</button>
        <button class="check" onclick="checkPermission('financial')">Check Financial</button>
        <button class="check" onclick="checkPermission('location')">Check Location</button>
        <button class="check" onclick="checkPermission('medical')">Check Medical</button>
        <div id="checkResult" class="result"></div>
    </div>

    <div class="test-card">
        <h2>üîì Active Permissions</h2>
        <button onclick="viewActivePermissions()">Refresh Active Permissions</button>
        <div id="activePermissions" class="result"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Configuration - Update this with your actual anon key
        const SUPABASE_URL = 'http://localhost:54321';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6ImFub24iLCJleHAiOjE5ODM4MTI5OTZ9.CRXP1A7WOeoJeXxjNni43kdQwgnWNReilDMblYTn_I0'; // Get this from: npx supabase status
        const FUNCTIONS_URL = 'http://localhost:54321/functions/v1';
        
        // Initialize Supabase client
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // TEMPORARY: Helper to get auth token for testing
        async function showToken() {
            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                // Show token in the yellow box
                document.getElementById('tokenDisplay').textContent = session.access_token;
                
                // Also copy to clipboard
                navigator.clipboard.writeText(session.access_token);
                alert('Token copied to clipboard!');
            } else {
                alert('Not logged in!');
            }
        }

        let sampleAppId = null;
        let currentUserId = null;
        let currentSession = null;

        // Check authentication status
        async function checkAuth() {
            const { data: { session } } = await supabase.auth.getSession();
            
            if (!session || !session.user) {
                // Not logged in, redirect to auth page
                window.location.href = 'auth.html';
                return;
            }
            
            // Store session and user ID for all operations
            currentSession = session;
            currentUserId = session.user.id;
            
            // Display user info
            document.getElementById('userEmail').textContent = session.user.email;
            document.getElementById('authInfo').style.display = 'flex';
        }

        // Logout function
        async function logout() {
            await supabase.auth.signOut();
            window.location.href = 'auth.html';
        }

        // Load data types from database
        async function loadDataTypes() {
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/data_types`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });
                const data = await response.json();
                
                const html = data.map(dt => 
                    `<span class="data-type">${dt.icon} ${dt.name} (${dt.sensitivity_level})</span>`
                ).join('');
                
                document.getElementById('dataTypes').innerHTML = 
                    `<div class="success">Found ${data.length} data types:</div>${html}`;
            } catch (error) {
                document.getElementById('dataTypes').innerHTML = 
                    `<div class="error">Error: ${error.message}</div>`;
            }
        }

        // Load the sample app
        async function loadSampleApp() {
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/apps?limit=1`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });
                const data = await response.json();
                
                if (data && data.length > 0) {
                    sampleAppId = data[0].id;
                    document.getElementById('sampleApp').innerHTML = 
                        `<div class="success">
                            <strong>App Name:</strong> ${data[0].name}<br>
                            <strong>App ID:</strong> ${data[0].id}<br>
                            <strong>Description:</strong> ${data[0].description}
                        </div>`;
                } else {
                    document.getElementById('sampleApp').innerHTML = 
                        `<div class="error">No sample app found</div>`;
                }
            } catch (error) {
                document.getElementById('sampleApp').innerHTML = 
                    `<div class="error">Error: ${error.message}</div>`;
            }
        }

        // Request permission using Edge Function
        async function requestPermission(dataType) {
            if (!sampleAppId) {
                alert('Please load the sample app first!');
                return;
            }

            if (!currentSession) {
                alert('Please log in first');
                window.location.href = 'auth.html';
                return;
            }

            try {
                const response = await fetch(`${FUNCTIONS_URL}/request-permission`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentSession.access_token}`
                    },
                    body: JSON.stringify({
                        app_id: sampleAppId,
                        data_type: dataType,
                        permission_level: 'read-write',
                        purpose: `To provide personalized ${dataType} insights and recommendations`,
                        duration_days: 30
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('permissionResult').innerHTML = 
                        `<div class="success">
                            ‚úÖ Permission requested successfully!<br>
                            <strong>Request ID:</strong> ${result.request_id}<br>
                            <strong>Status:</strong> ${result.status}<br>
                            <strong>Message:</strong> ${result.message}
                        </div>`;
                    // Refresh the requests list
                    viewRequests();
                } else {
                    document.getElementById('permissionResult').innerHTML = 
                        `<div class="error">Error: ${result.error}</div>`;
                }
            } catch (error) {
                document.getElementById('permissionResult').innerHTML = 
                    `<div class="error">Error: ${error.message}</div>`;
            }
        }

        // View all permission requests with grant buttons
        async function viewRequests() {
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/permission_requests?order=created_at.desc`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });
                const data = await response.json();
                
                if (data && data.length > 0) {
                    const html = data.map(req => 
                        `<div class="request-item">
                            <span class="status-badge status-${req.status}">${req.status.toUpperCase()}</span><br><br>
                            <strong>üì± Data Type:</strong> ${req.data_type}<br>
                            <strong>üîê Permission Level:</strong> ${req.permission_level}<br>
                            <strong>üìù Purpose:</strong> ${req.purpose}<br>
                            <strong>‚è±Ô∏è Duration:</strong> ${req.requested_duration || 'Permanent'}<br>
                            <strong>üìÖ Requested:</strong> ${new Date(req.created_at).toLocaleString()}<br>
                            ${req.status === 'pending' ? 
                                `<br><button class="grant" onclick="grantPermission('${req.id}')">‚úÖ Grant Permission</button>` 
                                : ''}
                        </div>`
                    ).join('');
                    
                    document.getElementById('requests').innerHTML = html;
                } else {
                    document.getElementById('requests').innerHTML = 
                        `<div class="info">No permission requests yet</div>`;
                }
            } catch (error) {
                document.getElementById('requests').innerHTML = 
                    `<div class="error">Error: ${error.message}</div>`;
            }
        }

        // Grant a permission request
        async function grantPermission(requestId) {
            if (!confirm('Grant this permission request?')) return;
            
            if (!currentSession) {
                alert('Please log in first');
                window.location.href = 'auth.html';
                return;
            }
            
            try {
                const response = await fetch(`${FUNCTIONS_URL}/grant-permission`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentSession.access_token}`
                    },
                    body: JSON.stringify({
                        request_id: requestId,
                        expires_in_days: 30
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    alert('‚úÖ Permission granted successfully!');
                    viewRequests(); // Refresh the requests
                    viewActivePermissions(); // Refresh active permissions
                } else {
                    alert('‚ùå Error: ' + result.error);
                }
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
            }
        }

        // Check if app has permission
        async function checkPermission(dataType) {
            if (!sampleAppId) {
                alert('Please load the sample app first!');
                return;
            }

            if (!currentSession) {
                alert('Please log in first');
                window.location.href = 'auth.html';
                return;
            }

            try {
                const response = await fetch(`${FUNCTIONS_URL}/check-permission`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentSession.access_token}`
                    },
                    body: JSON.stringify({
                        app_id: sampleAppId,
                        data_type: dataType,
                        permission_level: 'read'
                    })
                });

                const result = await response.json();
                
                const status = result.has_permission ? '‚úÖ HAS PERMISSION' : '‚ùå NO PERMISSION';
                document.getElementById('checkResult').innerHTML = 
                    `<div class="${result.has_permission ? 'success' : 'warning'}">
                        <strong>${status}</strong> for ${dataType} data<br>
                        ${result.permission ? 
                            `<br><strong>Permission Level:</strong> ${result.permission.permission_level}<br>
                             <strong>Expires:</strong> ${result.permission.expires_at ? 
                                new Date(result.permission.expires_at).toLocaleString() : 'Never'}` 
                            : ''}
                    </div>`;
            } catch (error) {
                document.getElementById('checkResult').innerHTML = 
                    `<div class="error">Error: ${error.message}</div>`;
            }
        }

        // View active permissions with revoke buttons
        async function viewActivePermissions() {
            // Check if user is logged in
            if (!currentUserId) {
                document.getElementById('activePermissions').innerHTML = 
                    '<div class="warning">Please log in to view permissions</div>';
                return;
            }

            try {
                // Query active_permissions filtered by current user
                const { data, error } = await supabase
                    .from('active_permissions')
                    .select('*')
                    .eq('user_id', currentUserId)
                    .order('granted_at', { ascending: false });

                if (error) {
                    console.error('Error fetching permissions:', error);
                    document.getElementById('activePermissions').innerHTML = 
                        `<div class="error">Error loading permissions: ${error.message}</div>`;
                    return;
                }
                
                if (data && data.length > 0) {
                    const html = data.map(perm => 
                        `<div class="permission-item">
                            <span class="status-badge status-${perm.status}">${perm.status.toUpperCase()}</span><br><br>
                            <strong>üì± App:</strong> ${perm.app_name}<br>
                            <strong>üîê Data Type:</strong> ${perm.data_type}<br>
                            <strong>üìä Permission Level:</strong> ${perm.permission_level}<br>
                            <strong>üìù Purpose:</strong> ${perm.purpose || 'Not specified'}<br>
                            <strong>üìÖ Granted:</strong> ${new Date(perm.granted_at).toLocaleString()}<br>
                            <strong>‚è∞ Expires:</strong> ${perm.expires_at ? 
                                new Date(perm.expires_at).toLocaleString() : 'Never'}<br>
                            <br><button class="revoke" onclick="revokePermission('${perm.id}')">üö´ Revoke Permission</button>
                        </div>`
                    ).join('');
                    
                    document.getElementById('activePermissions').innerHTML = html;
                } else {
                    document.getElementById('activePermissions').innerHTML = 
                        '<div class="info">No active permissions yet. Grant some requests first!</div>';
                }
            } catch (error) {
                document.getElementById('activePermissions').innerHTML = 
                    `<div class="error">Error: ${error.message}</div>`;
            }
        }

        // Revoke a permission
        async function revokePermission(permissionId) {
            if (!confirm('Revoke this permission? The app will immediately lose access.')) return;
            
            if (!currentSession) {
                alert('Please log in first');
                window.location.href = 'auth.html';
                return;
            }
            
            try {
                const response = await fetch(`${FUNCTIONS_URL}/revoke-permission`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentSession.access_token}`
                    },
                    body: JSON.stringify({
                        permission_id: permissionId
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    alert('‚úÖ Permission revoked successfully!');
                    viewActivePermissions(); // Refresh the list
                } else {
                    alert('‚ùå Error: ' + result.error);
                }
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
            }
        }

        // Auto-load on page load
        window.onload = async () => {
            // Check auth first
            await checkAuth();
            
            // If authenticated, load everything
            if (currentUserId) {
                loadSampleApp();
                loadDataTypes();
                viewRequests();
                viewActivePermissions();
            }
        };
    </script>
</body>
</html>